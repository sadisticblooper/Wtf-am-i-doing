<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SF3 Animation Binary Viewer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Courier New', monospace;
        }

        body {
            background: #0a0a0f;
            color: #e0e0ff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(20, 20, 40, 0.8);
            border-radius: 10px;
            border: 1px solid #333366;
        }

        h1 {
            color: #ff5555;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 0 10px rgba(255, 85, 85, 0.3);
        }

        .subtitle {
            color: #55aaff;
            font-size: 1.1em;
        }

        .upload-box {
            background: rgba(20, 20, 40, 0.8);
            padding: 25px;
            border-radius: 10px;
            border: 2px dashed #5555ff;
            margin-bottom: 30px;
            text-align: center;
        }

        #fileInput {
            display: none;
        }

        .file-button {
            background: linear-gradient(45deg, #ff5555, #aa5555);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 5px;
            font-size: 1.2em;
            cursor: pointer;
            margin-bottom: 20px;
            transition: all 0.3s;
        }

        .file-button:hover {
            background: linear-gradient(45deg, #ff7777, #cc5555);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 85, 85, 0.4);
        }

        .file-info {
            margin-top: 15px;
            color: #55ff55;
            font-size: 0.9em;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-box {
            background: rgba(30, 30, 60, 0.8);
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #5555ff;
        }

        .stat-value {
            font-size: 2.5em;
            color: #ffaa55;
            font-weight: bold;
        }

        .stat-label {
            color: #aaddff;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .controls {
            background: rgba(20, 20, 40, 0.8);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .control-label {
            color: #55aaff;
        }

        select {
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border: 1px solid #5555ff;
            padding: 8px 15px;
            border-radius: 5px;
            min-width: 150px;
        }

        #frameSlider {
            flex: 1;
            min-width: 300px;
            background: rgba(0, 0, 0, 0.5);
            height: 10px;
            border-radius: 5px;
            -webkit-appearance: none;
        }

        #frameSlider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: #ff5555;
            border-radius: 50%;
            cursor: pointer;
        }

        .data-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .bone-list {
            background: rgba(20, 20, 40, 0.8);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #333366;
            max-height: 600px;
            overflow-y: auto;
        }

        .bone-item {
            background: rgba(40, 40, 80, 0.5);
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            border-left: 3px solid #55aaff;
        }

        .bone-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .bone-id {
            color: #ffaa55;
            font-weight: bold;
            font-size: 1.1em;
        }

        .bone-index {
            color: #55ff55;
            font-size: 0.9em;
        }

        .transform-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .transform-box {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 5px;
        }

        .transform-label {
            color: #55aaff;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .transform-values {
            color: #e0e0ff;
            font-size: 0.9em;
            line-height: 1.4;
        }

        .raw-data {
            background: rgba(20, 20, 40, 0.8);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #333366;
        }

        .raw-header {
            color: #ff5555;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .hex-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .hex-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 8px;
            border-radius: 5px;
            text-align: center;
        }

        .hex-label {
            color: #55aaff;
            font-size: 0.8em;
        }

        .hex-value {
            color: #55ff55;
            font-size: 1.1em;
            font-family: monospace;
        }

        .messages {
            margin-bottom: 30px;
        }

        .message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: none;
        }

        .message.error {
            background: rgba(255, 85, 85, 0.1);
            border: 1px solid rgba(255, 85, 85, 0.3);
            color: #ffaaaa;
            display: block;
        }

        .message.success {
            background: rgba(85, 255, 85, 0.1);
            border: 1px solid rgba(85, 255, 85, 0.3);
            color: #aaffaa;
            display: block;
        }

        .message.warning {
            background: rgba(255, 255, 85, 0.1);
            border: 1px solid rgba(255, 255, 85, 0.3);
            color: #ffffaa;
            display: block;
        }

        @media (max-width: 768px) {
            .data-section {
                grid-template-columns: 1fr;
            }
            
            .stats {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            #frameSlider {
                min-width: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>SF3 ANIMATION BINARY VIEWER</h1>
            <p class="subtitle">Upload Shadow Fight 3 animation binary files (.bin)</p>
        </header>

        <div class="messages">
            <div id="errorMessage" class="message error"></div>
            <div id="successMessage" class="message success"></div>
            <div id="warningMessage" class="message warning"></div>
        </div>

        <div class="upload-box">
            <label for="fileInput" class="file-button">üìÅ SELECT ANIMATION FILE</label>
            <input type="file" id="fileInput" accept=".bin">
            <div id="fileInfo" class="file-info"></div>
        </div>

        <div id="stats" style="display: none;">
            <div class="stats">
                <div class="stat-box">
                    <div class="stat-value" id="totalFrames">0</div>
                    <div class="stat-label">TOTAL FRAMES</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="totalBones">0</div>
                    <div class="stat-label">TOTAL BONES</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="currentFrameNum">0</div>
                    <div class="stat-label">CURRENT FRAME</div>
                </div>
            </div>

            <div class="controls">
                <div class="control-group">
                    <span class="control-label">FRAME:</span>
                    <select id="frameSelect"></select>
                </div>
                <div class="control-group">
                    <span class="control-label">BONE:</span>
                    <select id="boneSelect">
                        <option value="all">ALL BONES</option>
                    </select>
                </div>
                <input type="range" id="frameSlider" min="1" max="100" value="1">
                <div class="control-group">
                    <button id="exportBtn" style="background: #5555ff; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">
                        EXPORT CSV
                    </button>
                </div>
            </div>

            <div class="data-section">
                <div class="bone-list">
                    <h3 style="color: #55aaff; margin-bottom: 15px;">BONE TRANSFORMS</h3>
                    <div id="boneList"></div>
                </div>
                <div class="raw-data">
                    <h3 class="raw-header">RAW BINARY DATA</h3>
                    <div id="rawData"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class SF3AnimationParser {
            constructor() {
                this.data = null;
                this.frames = [];
                this.boneIds = [];
                this.currentFrame = 1;
                this.currentBoneFilter = 'all';
            }

            // Simple half to float conversion
            halfToFloat(h) {
                const s = (h & 0x8000) >> 15;
                const e = (h & 0x7C00) >> 10;
                const f = h & 0x03FF;

                if (e === 0) {
                    return (s ? -1 : 1) * Math.pow(2, -14) * (f / 1024);
                } else if (e === 31) {
                    return f ? NaN : (s ? -Infinity : Infinity);
                }

                return (s ? -1 : 1) * Math.pow(2, e - 15) * (1 + f / 1024);
            }

            // Fix: Correct quaternion decompression from C++ code
            decompressQuaternion(v0, v1, v2) {
                const maxValue = 1.4142135;
                const shift = 0.70710677;
                const scale = maxValue / 32767.0;

                // Calculate v2, v4, v5 as per C++ code
                const v2_val = (v1 >> 14) + 4 * (v0 & 0x1FFF);
                const v4 = (v2 >> 15) + 2 * (v1 & 0x3FFF);
                const v5 = v2 & 0x7FFF;

                // Decompress values
                const a = v2_val * scale - shift;
                const b = v4 * scale - shift;
                const c = v5 * scale - shift;

                // Calculate fourth component
                const d = Math.sqrt(Math.max(0, 1 - a*a - b*b - c*c));

                // Get missing component index
                const missing = (v0 >> 13) & 3;

                // Reconstruct quaternion based on missing component
                let x, y, z, w;
                if (missing === 0) { // x is missing
                    x = d;
                    y = a;
                    z = b;
                    w = c;
                } else if (missing === 1) { // y is missing
                    x = a;
                    y = d;
                    z = b;
                    w = c;
                } else if (missing === 2) { // z is missing
                    x = a;
                    y = b;
                    z = d;
                    w = c;
                } else { // w is missing (missing === 3)
                    x = a;
                    y = b;
                    z = c;
                    w = d;
                }

                // Normalize quaternion
                const len = Math.sqrt(x*x + y*y + z*z + w*w);
                if (len > 0) {
                    x /= len;
                    y /= len;
                    z /= len;
                    w /= len;
                }

                return [x, y, z, w];
            }

            parseBinary(dataView) {
                let offset = 0;
                
                // Check header
                const header = dataView.getBigInt64(offset, true);
                offset += 8;
                
                if (header !== 457546134634734n) {
                    throw new Error(`Invalid file format. Expected header 457546134634734, got ${header}`);
                }

                // Read array count
                const arrayCount = dataView.getInt16(offset, true);
                offset += 2;

                // Skip garbage buffer
                offset += arrayCount * 8;

                // Read frame count
                const frameCount = dataView.getInt32(offset, true);
                offset += 4;

                // Read bone count
                const boneCount = dataView.getInt32(offset, true);
                offset += 4;

                // Read bone IDs
                this.boneIds = [];
                for (let i = 0; i < boneCount; i++) {
                    this.boneIds.push(dataView.getInt16(offset, true));
                    offset += 2;
                }

                // Parse frames
                this.frames = [];
                for (let frameIdx = 0; frameIdx < frameCount; frameIdx++) {
                    const frame = {
                        index: frameIdx + 1,
                        bones: []
                    };

                    for (let boneIdx = 0; boneIdx < boneCount; boneIdx++) {
                        // Read 6 uint16 values per bone
                        const px = dataView.getUint16(offset, true); offset += 2;
                        const py = dataView.getUint16(offset, true); offset += 2;
                        const pz = dataView.getUint16(offset, true); offset += 2;
                        const v0 = dataView.getUint16(offset, true); offset += 2;
                        const v1 = dataView.getUint16(offset, true); offset += 2;
                        const v2 = dataView.getUint16(offset, true); offset += 2;

                        // Convert position
                        const pos = [
                            this.halfToFloat(px),
                            this.halfToFloat(py),
                            this.halfToFloat(pz)
                        ];

                        // Decompress quaternion
                        const rot = this.decompressQuaternion(v0, v1, v2);

                        frame.bones.push({
                            boneId: this.boneIds[boneIdx],
                            position: pos,
                            rotation: rot,
                            raw: { px, py, pz, v0, v1, v2 }
                        });
                    }

                    this.frames.push(frame);
                }

                return {
                    frames: this.frames,
                    frameCount,
                    boneCount,
                    boneIds: this.boneIds,
                    totalSize: offset
                };
            }
        }

        class Viewer {
            constructor() {
                this.parser = new SF3AnimationParser();
                this.currentFrame = 1;
                this.init();
            }

            init() {
                document.getElementById('fileInput').addEventListener('change', (e) => this.handleFile(e));
                document.getElementById('frameSelect').addEventListener('change', (e) => this.changeFrame(parseInt(e.target.value)));
                document.getElementById('boneSelect').addEventListener('change', (e) => this.filterBones(e.target.value));
                document.getElementById('frameSlider').addEventListener('input', (e) => {
                    this.changeFrame(parseInt(e.target.value));
                    document.getElementById('frameSelect').value = e.target.value;
                });
                document.getElementById('exportBtn').addEventListener('click', () => this.exportCSV());
            }

            showMessage(type, text) {
                const msg = document.getElementById(`${type}Message`);
                msg.textContent = text;
                msg.style.display = 'block';
                setTimeout(() => msg.style.display = 'none', 5000);
            }

            async handleFile(event) {
                const file = event.target.files[0];
                if (!file) return;

                document.getElementById('fileInfo').textContent = `File: ${file.name} (${(file.size/1024).toFixed(2)} KB)`;

                try {
                    const buffer = await file.arrayBuffer();
                    const dataView = new DataView(buffer);
                    
                    const result = this.parser.parseBinary(dataView);
                    
                    this.showUI(result);
                    this.updateFrameSelect(result.frameCount);
                    this.updateBoneSelect(result.boneIds);
                    this.displayFrame(1);
                    
                    this.showMessage('success', `Loaded ${result.frameCount} frames, ${result.boneCount} bones`);
                    
                } catch (error) {
                    this.showMessage('error', `Error: ${error.message}`);
                    console.error('Parse error:', error);
                }
            }

            showUI(data) {
                document.getElementById('stats').style.display = 'block';
                document.getElementById('totalFrames').textContent = data.frameCount;
                document.getElementById('totalBones').textContent = data.boneCount;
                document.getElementById('frameSlider').max = data.frameCount;
            }

            updateFrameSelect(count) {
                const select = document.getElementById('frameSelect');
                select.innerHTML = '';
                for (let i = 1; i <= count; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = `Frame ${i}`;
                    select.appendChild(option);
                }
            }

            updateBoneSelect(boneIds) {
                const select = document.getElementById('boneSelect');
                select.innerHTML = '<option value="all">ALL BONES</option>';
                boneIds.forEach(id => {
                    const option = document.createElement('option');
                    option.value = id;
                    option.textContent = `Bone ${id}`;
                    select.appendChild(option);
                });
            }

            changeFrame(frameNum) {
                this.currentFrame = frameNum;
                document.getElementById('currentFrameNum').textContent = frameNum;
                document.getElementById('frameSlider').value = frameNum;
                this.displayFrame(frameNum);
            }

            filterBones(boneId) {
                this.parser.currentBoneFilter = boneId;
                this.displayFrame(this.currentFrame);
            }

            displayFrame(frameNum) {
                const frame = this.parser.frames[frameNum - 1];
                if (!frame) return;

                const boneList = document.getElementById('boneList');
                boneList.innerHTML = '';

                const rawData = document.getElementById('rawData');
                rawData.innerHTML = '';

                const boneFilter = this.parser.currentBoneFilter;
                const bonesToShow = boneFilter === 'all' 
                    ? frame.bones 
                    : frame.bones.filter(b => b.boneId.toString() === boneFilter);

                // Display bone transforms
                bonesToShow.forEach((bone, idx) => {
                    const boneItem = document.createElement('div');
                    boneItem.className = 'bone-item';
                    boneItem.innerHTML = `
                        <div class="bone-header">
                            <span class="bone-id">BONE ${bone.boneId}</span>
                            <span class="bone-index">#${idx + 1}</span>
                        </div>
                        <div class="transform-grid">
                            <div class="transform-box">
                                <div class="transform-label">POSITION</div>
                                <div class="transform-values">
                                    X: ${bone.position[0].toFixed(6)}<br>
                                    Y: ${bone.position[1].toFixed(6)}<br>
                                    Z: ${bone.position[2].toFixed(6)}
                                </div>
                            </div>
                            <div class="transform-box">
                                <div class="transform-label">ROTATION</div>
                                <div class="transform-values">
                                    X: ${bone.rotation[0].toFixed(6)}<br>
                                    Y: ${bone.rotation[1].toFixed(6)}<br>
                                    Z: ${bone.rotation[2].toFixed(6)}<br>
                                    W: ${bone.rotation[3].toFixed(6)}
                                </div>
                            </div>
                        </div>
                    `;
                    boneList.appendChild(boneItem);
                });

                // Display raw hex data for first bone
                if (bonesToShow.length > 0) {
                    const firstBone = bonesToShow[0];
                    const hexGrid = document.createElement('div');
                    hexGrid.className = 'hex-grid';
                    
                    ['px', 'py', 'pz', 'v0', 'v1', 'v2'].forEach(key => {
                        const hexItem = document.createElement('div');
                        hexItem.className = 'hex-item';
                        hexItem.innerHTML = `
                            <div class="hex-label">${key.toUpperCase()}</div>
                            <div class="hex-value">0x${firstBone.raw[key].toString(16).padStart(4, '0')}</div>
                        `;
                        hexGrid.appendChild(hexItem);
                    });
                    
                    rawData.appendChild(hexGrid);
                    
                    // Add binary breakdown
                    const breakdown = document.createElement('div');
                    breakdown.style.marginTop = '20px';
                    breakdown.innerHTML = `
                        <div style="color: #55aaff; margin-bottom: 10px;">QUATERNION BREAKDOWN:</div>
                        <div style="color: #e0e0ff; font-size: 0.9em; line-height: 1.5;">
                            v0: 0x${firstBone.raw.v0.toString(2).padStart(16, '0').replace(/(.{4})/g, '$1 ')}<br>
                            v1: 0x${firstBone.raw.v1.toString(2).padStart(16, '0').replace(/(.{4})/g, '$1 ')}<br>
                            v2: 0x${firstBone.raw.v2.toString(2).padStart(16, '0').replace(/(.{4})/g, '$1 ')}
                        </div>
                    `;
                    rawData.appendChild(breakdown);
                }
            }

            exportCSV() {
                if (!this.parser.frames.length) {
                    this.showMessage('warning', 'No data to export');
                    return;
                }

                const csvRows = ['frame,bone_id,pos_x,pos_y,pos_z,rot_x,rot_y,rot_z,rot_w'];
                
                this.parser.frames.forEach(frame => {
                    frame.bones.forEach(bone => {
                        const row = [
                            frame.index,
                            bone.boneId,
                            bone.position[0].toFixed(6),
                            bone.position[1].toFixed(6),
                            bone.position[2].toFixed(6),
                            bone.rotation[0].toFixed(6),
                            bone.rotation[1].toFixed(6),
                            bone.rotation[2].toFixed(6),
                            bone.rotation[3].toFixed(6)
                        ];
                        csvRows.push(row.join(','));
                    });
                });

                const csvContent = csvRows.join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `sf3_animation_${Date.now()}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                this.showMessage('success', 'CSV exported successfully');
            }
        }

        // Initialize viewer
        const viewer = new Viewer();
    </script>
</body>
</html>
