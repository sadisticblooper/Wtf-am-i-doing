<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SF3 Animation Diddler & Visualizer</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Styles kept identical to user upload for consistency */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background-color: #111827; 
            color: white; 
            /* FIX 1: Use 100dvh for browsers that support it (Chrome/Mobile), fallback to 100vh */
            height: 100vh; 
            height: 100dvh; 
            overflow: hidden; 
        }

        .app-container { 
            display: flex; 
            /* FIX 2: Fill the body height exactly */
            height: 100%; 
            width: 100vw; 
        }

        .sidebar { 
            width: 320px; 
            background-color: #1f2937; 
            border-right: 1px solid #374151; 
            display: flex; 
            flex-direction: column; 
            z-index: 10; 
            box-shadow: 5px 0 15px rgba(0, 0, 0, 0.3); 
            /* FIX 3: Ensure sidebar fits 100% of container and handles its own overflow */
            height: 100%;
            overflow: hidden; 
        }

        .sidebar-header { padding: 24px; border-bottom: 1px solid #374151; flex-shrink: 0; }
        .app-title { font-size: 24px; font-weight: bold; color: #10b981; display: flex; align-items: center; gap: 8px; }
        .app-subtitle { color: #9ca3af; font-size: 12px; margin-top: 4px; }
        
        /* Layout logic */
        .sidebar-content { 
            padding: 24px; 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            /* FIX 4: min-height 0 prevents flex child from overflowing parent */
            min-height: 0; 
            overflow: hidden; 
        }

        .scrollable-content { 
            flex: 1; 
            overflow-y: auto; 
            padding-right: 8px; 
        }
        
        .scrollable-content::-webkit-scrollbar { width: 6px; }
        .scrollable-content::-webkit-scrollbar-track { background: #1f2937; }
        .scrollable-content::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 3px; }
        .scrollable-content::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        
        /* Footer stays pinned at bottom */
        .sidebar-footer { padding: 24px 24px 24px 24px; border-top: 1px solid #374151; flex-shrink: 0; background-color: #1f2937; }
        
        .section-title { display: block; font-size: 14px; font-weight: 600; color: #d1d5db; margin-bottom: 12px; }
        .file-section { margin-bottom: 16px; position: relative; }
        .file-upload-area { border: 2px dashed #4b5563; border-radius: 8px; padding: 24px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s ease; min-height: 140px; }
        .file-upload-area:hover { border-color: #10b981; background-color: rgba(16, 185, 129, 0.05); }
        .file-icon { font-size: 32px; color: #6b7280; margin-bottom: 8px; }
        .file-name { font-size: 14px; color: #9ca3af; text-align: center; word-break: break-word; }
        .file-input { display: none; }
        .playback-controls { display: flex; gap: 8px; margin-bottom: 24px; }
        .play-button { flex: 1; display: flex; align-items: center; justify-content: center; gap: 8px; padding: 10px; border-radius: 6px; font-weight: bold; border: none; cursor: pointer; color: white; }
        .play-button.play { background-color: #10b981; }
        .play-button.pause { background-color: #ef4444; }
        .slider-container { margin-bottom: 24px; }
        .slider-label { display: flex; justify-content: space-between; font-size: 12px; color: #9ca3af; margin-bottom: 4px; }
        .slider { width: 100%; height: 6px; -webkit-appearance: none; background: #374151; border-radius: 3px; outline: none; }
        .slider::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; border-radius: 50%; background: #10b981; cursor: pointer; }
        .stats-container { background-color: #1f2937; padding: 12px; border-radius: 6px; border: 1px solid #374151; margin-bottom: 24px; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; font-size: 12px; }
        .stat-value { text-align: right; color: #d1d5db; }
        .export-button { width: 100%; padding: 10px; background-color: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 8px; font-weight: 600; transition: all 0.2s ease; }
        .export-button:hover { background-color: #0da271; transform: translateY(-1px); }
        .export-button:disabled { opacity: 0.5; cursor: not-allowed; background-color: #374151; }
        .export-button:disabled:hover { transform: none; background-color: #374151; }
        .viewport { flex: 1; position: relative; background: linear-gradient(to bottom, #111827, #000); }
        .canvas-container { width: 100%; height: 100%; }
        .waiting-message { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: #4b5563; font-size: 18px; pointer-events: none; }
        .status-message { margin-top: 8px; border-radius: 4px; font-size: 12px; min-height: 20px; }
        .status-error { color: #fca5a5; background-color: rgba(239, 68, 68, 0.1); padding: 8px; }
        .status-loading { color: #fbbf24; padding: 8px; }
        .controls-section { margin-bottom: 0; }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="sidebar">
            <div class="sidebar-header">
                <h1 class="app-title"><span>☠️</span> SF3 Diddler</h1>
                <p class="app-subtitle">Binary Animation Parser & Viewer</p>
            </div>
            
            <div class="sidebar-content">
                <div class="scrollable-content">
                    <div class="file-section">
                        <span class="section-title">1. Load Animation File (.bytes)</span>
                        <div class="file-upload-area" id="fileUploadArea">
                            <div class="file-icon"><i class="far fa-file"></i></div>
                            <span class="file-name" id="fileName">Click to browse</span>
                            <input type="file" class="file-input" id="fileInput" accept=".bytes,.bin,.dat,.anim">
                        </div>
                        <div id="statusMessage" class="status-message"></div>
                    </div>
                    
                    <div class="controls-section" id="controlsSection">
                        <span class="section-title">2. Playback Controls</span>
                        <div class="playback-controls">
                            <button class="play-button play" id="playButton">
                                <i class="fas fa-play"></i> Play
                            </button>
                        </div>
                        
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>Timeline</span>
                                <span class="slider-value" id="frameCounter">0 / 0</span>
                            </div>
                            <input type="range" min="1" max="100" value="1" class="slider" id="timelineSlider">
                        </div>
                        
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>Speed</span>
                                <span class="slider-value" id="speedValue">30 FPS</span>
                            </div>
                            <input type="range" min="1" max="120" value="30" class="slider speed-slider" id="speedSlider">
                        </div>
                        
                        <div class="stats-container">
                            <div class="stats-title">Metadata</div>
                            <div class="stats-grid">
                                <span class="stat-label">Bones:</span> <span class="stat-value" id="bonesCount">0</span>
                                <span class="stat-label">Frames:</span> <span class="stat-value" id="framesCount">0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Footer is pinned at the bottom and won't overflow -->
            <div class="sidebar-footer">
                <button class="export-button" id="exportButton" disabled>
                    <i class="fas fa-download"></i> Export Data (CSV)
                </button>
            </div>
        </div>
        
        <div class="viewport">
            <div class="canvas-container" id="canvasContainer"></div>
            <div class="waiting-message" id="waitingMessage">Waiting for animation file...</div>
        </div>
    </div>

    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/examples/": "https://unpkg.com/three@0.160.0/examples/"
        }
    }
    </script>
    
    <script type="module" src="./constants.js"></script>
    <script type="module" src="./parser.js"></script>
    <script type="module" src="./scene.js"></script>
    <script type="module" src="./app.js"></script>
</body>
</html>
